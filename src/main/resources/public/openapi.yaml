openapi: 3.0.0
info:
  title: STEDI API
  description: |
    API documentation for the STEDI application
    
    ## Authentication
    Most endpoints require authentication using a session token obtained from the `/login` endpoint.
    
    **Required Header:**
    - `suresteps.session.token`: Session token value (UUID format)
    
    **Authentication Flow:**
    1. Call `/login` with username and password to get a session token
    2. Include the token in the `suresteps.session.token` header for authenticated requests
    3. Use `/validate/{token}` to verify token validity
    
    ## Two-Factor Authentication
    The API supports 2FA via SMS and WhatsApp:
    - Request OTP: `/twofactorlogin/{phoneNumber}`
    - Verify OTP: `/twofactorlogin` (POST with phoneNumber and oneTimePassword)
  version: 1.0.0

servers:
  - url: https://dev.stedi.me/
    description: Development server
  - url: http://localhost:4567
    description: Local development server

components:
  securitySchemes:
    sessionToken:
      type: apiKey
      name: suresteps.session.token
      in: header
  schemas:
    DeviceMessage:
      type: object
      properties:
        messageOrigin:
          type: string
          example: DEVICE
        sessionKey:
          type: string
          nullable: true
        message:
          type: string
          example: "Sample update from spotter-7"
        deviceId:
          type: string
          example: spotter-7.stedi.local
        date:
          type: number
          format: int64
          example: 1659538351527
        sensorType:
          type: string
          example: ultraSonicSensor
        distance:
          type: string
          example: 1cm
        timestamp:
          type: number
          format: int64
          example: 1659538351527

    User:
      type: object
      properties:
        userName:
          type: string
          format: email
          example: user@example.com
          description: User's email address (used as username)
        password:
          type: string
          description: User's password (only used for input, never returned)
        phone:
          type: string
          example: "+18017190908"
          description: User's phone number in international format
        whatsAppPhone:
          type: string
          example: "+18017190908"
          description: User's WhatsApp phone number
        email:
          type: string
          format: email
          example: user@example.com
          description: User's email address
        birthDay:
          type: string
          example: "08151990"
          description: User's birth date in MMDDYYYY format
        gender:
          type: string
          example: "M"
          description: User's gender
        region:
          type: string
          example: "US"
          description: User's region code
        expoPushToken:
          type: string
          example: "ExponentPushToken[abc123]"
          description: Expo push notification token for mobile app
        deviceNickName:
          type: string
          example: "MyDevice"
          description: Nickname for user's device
        agreedToTermsOfUseDate:
          type: number
          format: int64
          example: 1659538351527
          description: Timestamp when user agreed to terms of use
        agreedToPrivacyPolicyDate:
          type: number
          format: int64
          example: 1659538351527
          description: Timestamp when user agreed to privacy policy
        agreedToCookiePolicyDate:
          type: number
          format: int64
          example: 1659538351527
          description: Timestamp when user agreed to cookie policy
        agreedToTextMessageDate:
          type: number
          format: int64
          example: 1659538351527
          description: Timestamp when user agreed to receive text messages
        agreedToShareAnonymousData:
          type: number
          format: int64
          example: 1659538351527
          description: Timestamp when user agreed to share anonymous data for research purposes
        locked:
          type: boolean
          example: false
          description: Whether the user account is locked

    Customer:
      type: object
      properties:
        customerName:
          type: string
          example: "John Doe"
          description: Customer's full name
        email:
          type: string
          format: email
          example: "customer@example.com"
          description: Customer's email address
        phone:
          type: string
          example: "+18017190908"
          description: Customer's phone number in international format
        whatsAppPhone:
          type: string
          example: "+18017190908"
          description: Customer's WhatsApp phone number
        birthDay:
          type: string
          example: "08151990"
          description: Customer's birth date in MMDDYYYY format
        region:
          type: string
          example: "US"
          description: Customer's region code
        weight:
          type: number
          format: int64
          example: 150
          description: Customer's weight (in pounds or kilograms)
        height:
          type: number
          format: int64
          example: 70
          description: Customer's height (in inches or centimeters)
        lastWalkerDate:
          type: string
          format: date-time
          example: "2023-08-15T10:30:00Z"
          description: Date of customer's last walker usage
        gender:
          type: string
          example: "M"
          description: Customer's gender

paths:
  /login:
    post:
      summary: Log in to STEDI
      description: Authenticate user and obtain a session token for subsequent API calls
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userName
                - password
              properties:
                userName:
                  type: string
                  format: email
                  example: user@test.com
                  description: User's email address
                password:
                  type: string
                  example: P@ssw0rd
                  description: User's password
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              schema:
                type: string
                description: Session token (UUID format)
                example: e16b6030-433d-4287-ac1b-df500851e8da
        '401':
          description: Invalid credentials

  /rapidsteptest:
    post:
      summary: Save Steps
      description: Save step test data including timing and step measurements
      security:
        - sessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - customer
                - startTime
                - stepPoints
                - stopTime
                - testTime
                - totalSteps
                - deviceId
              properties:
                customer:
                  type: string
                  format: email
                  example: user@test.com
                  description: Customer email address
                startTime:
                  type: number
                  example: 1659538351527
                  description: Test start time (timestamp)
                stepPoints:
                  type: array
                  items:
                    type: number
                  example: [3615, 1165, 756, 309, 200, 172, 166, 171, 166, 172, 171, 186, 172, 180, 165, 179, 192, 172, 178, 173, 172, 180, 165, 179, 192, 172, 178, 173, 178, 180]
                  description: Array of step measurement points
                stopTime:
                  type: number
                  example: 1659538363373
                  description: Test stop time (timestamp)
                testTime:
                  type: number
                  example: 11846
                  description: Total test duration in milliseconds
                totalSteps:
                  type: number
                  example: 30
                  description: Total number of steps recorded
                deviceId:
                  type: string
                  example: "007"
                  description: Device identifier
      responses:
        '200':
          description: Steps saved successfully
        '401':
          description: Unauthorized - Invalid or missing session token

  /sensorUpdates:
    post:
      summary: Send Sensor Updates
      description: Send sensor data updates from connected devices to the STEDI platform for processing and routing to interested sessions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - deviceId
                - sensorType
                - distance
                - timestamp
              properties:
                deviceId:
                  type: string
                  example: "007"
                  description: Unique identifier for the device sending the sensor data
                sensorType:
                  type: string
                  example: "ultraSonicSensor"
                  description: Type of sensor providing the data (e.g., ultraSonicSensor, accelerometer, gyroscope)
                distance:
                  type: string
                  example: "1cm"
                  description: Distance measurement from ultrasonic sensor
                timestamp:
                  type: number
                  example: 1659538351527
                  description: Timestamp when the sensor reading was captured (Unix timestamp in milliseconds)
                message:
                  type: string
                  example: "Test Completed"
                  description: Unstructured message or status text from the device
                messageOrigin:
                  type: string
                  example: "DEVICE"
                  description: Origin type of the message (typically "DEVICE" for sensor updates)
                date:
                  type: number
                  example: 1659538351527
                  description: Timestamp when the sensor data was captured (Unix timestamp in milliseconds)
      responses:
        '200':
          description: Sensor data accepted and routed successfully
          content:
            application/json:
              schema:
                type: string
                example: "Accepted"
        '400':
          description: Invalid sensor data format or missing required fields
        '500':
          description: Internal server error processing sensor data

  /devices/updates/recent:
    get:
      summary: Get recent updates for the caller's device
      description: |
        Returns sensor updates for the authenticated user's device in the last N seconds.
        The user's device is inferred from their `deviceNickName` profile field.
      security:
        - sessionToken: []
      parameters:
        - name: seconds
          in: query
          required: false
          schema:
            type: integer
            default: 60
            minimum: 1
          description: Time window in seconds to look back for updates
      responses:
        '200':
          description: Recent device updates returned
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DeviceMessage'
        '400':
          description: Missing device nickname or invalid parameter
        '401':
          description: Unauthorized - Invalid or missing session token
        '500':
          description: Error querying recent device updates

  /riskscore/{email}:
    get:
      summary: Get Risk Score
      security:
        - sessionToken: []
      parameters:
        - name: email
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Risk score retrieved successfully

  /stephistory/{customer}:
    get:
      summary: Get Step History
      security:
        - sessionToken: []
      parameters:
        - name: customer
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Step history retrieved successfully

  /validate/{token}:
    get:
      summary: Validate Token
      description: Validate a session token and retrieve associated email address
      parameters:
        - name: token
          in: path
          required: true
          schema:
            type: string
            format: uuid
          example: f4f4f3b3-1d35-488c-af13-f2fd095567cf
          description: Session token to validate
      responses:
        '200':
          description: Token validated successfully
          content:
            application/json:
              schema:
                type: string
                description: Email address associated with the token
        '401':
          description: Invalid token

  /twofactorlogin/{phoneNumber}:
    post:
      summary: Request 2FA OTP
      description: Request a one-time password via SMS or WhatsApp
      parameters:
        - name: phoneNumber
          in: path
          required: true
          schema:
            type: string
          example: "8017190908"
          description: Phone number to send OTP to
        - name: whatsApp
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Send via WhatsApp instead of SMS
        - name: region
          in: query
          required: false
          schema:
            type: string
            default: "US"
          description: Region code for WhatsApp messages
      responses:
        '200':
          description: OTP sent successfully

  /twofactorlogin:
    post:
      summary: Convert OTP to Token
      description: Verify OTP and receive session token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phoneNumber
                - oneTimePassword
              properties:
                phoneNumber:
                  type: string
                  example: "8017190908"
                  description: Phone number that received the OTP
                oneTimePassword:
                  type: number
                  example: 8936
                  description: One-time password received via SMS/WhatsApp
      responses:
        '200':
          description: OTP verified successfully, session token returned
          content:
            application/json:
              schema:
                type: string
                description: Session token (UUID format)
        '401':
          description: Invalid OTP or phone number

  /birthdateverify/{phoneNumber}:
    post:
      summary: Verify Birth Date and Get Token
      description: Verify birth date against customer records and receive session token
      parameters:
        - name: phoneNumber
          in: path
          required: true
          schema:
            type: string
          example: "8017190908"
          description: Phone number of the customer
        - name: region
          in: query
          required: false
          schema:
            type: string
            default: "US"
          description: Region code for phone number formatting
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - dateOfBirth
              properties:
                dateOfBirth:
                  type: string
                  pattern: '^\d{8}$'
                  example: "08151990"
                  description: Date of birth in MMDDYYYY format (8 digits)
      responses:
        '200':
          description: Birth date verified successfully, session token returned
          content:
            application/json:
              schema:
                type: string
                description: Session token (UUID format)
        '400':
          description: Invalid birth date format or birth date doesn't match records
        '404':
          description: User or customer not found

  /sendtext:
    post:
      summary: Send WhatsApp/SMS Message
      description: Send a text message via SMS or WhatsApp
      security:
        - sessionToken: []
      parameters:
        - name: whatsApp
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Send via WhatsApp instead of SMS
        - name: region
          in: query
          required: false
          schema:
            type: string
            default: "US"
          description: Region code for WhatsApp messages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - phoneNumber
                - message
              properties:
                phoneNumber:
                  type: string
                  example: "18017190908"
                  description: Recipient phone number
                message:
                  type: string
                  example: "10"
                  description: Message content
      responses:
        '200':
          description: Message sent successfully
        '401':
          description: Unauthorized - Invalid or missing session token

  /user/{username}:
    delete:
      summary: Delete User
      security:
        - sessionToken: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User deleted successfully
    patch:
      summary: Update User
      description: Update user profile information including expo push token
      security:
        - sessionToken: []
      parameters:
        - name: username
          in: path
          required: true
          schema:
            type: string
            format: email
          example: marjorieabankwa@gmail.com
          description: Username (email address) of user to update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                customerName:
                  type: string
                  example: Marjorie
                  description: Customer's full name
                email:
                  type: string
                  format: email
                  example: marjorieta222@gmail.com
                  description: Updated email address
                phone:
                  type: string
                  example: "+1385-452-0644"
                  description: Updated phone number
                whatsAppPhone:
                  type: string
                  example: "+1385-452-0644"
                  description: WhatsApp phone number
                birthDay:
                  type: string
                  format: date
                  example: "2004-10-19"
                  description: Birth date (YYYY-MM-DD)
                expoPushToken:
                  type: string
                  example: samplepushtoken
                  description: Expo push notification token
                deviceNickName:
                  type: string
                  example: spotter-7.stedi.local
                  description: Device nickname (used to link device updates)
      responses:
        '200':
          description: User updated successfully
        '401':
          description: Unauthorized - Invalid or missing session token
        '404':
          description: User not found

  /customer/lastwalkerdate/{phoneNumber}/{days}:
    patch:
      summary: Update Last Walker Usage Date
      security:
        - sessionToken: []
      parameters:
        - name: phoneNumber
          in: path
          required: true
          schema:
            type: string
        - name: days
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Last walker date updated successfully

  /customer/{phone}:
    get:
      summary: Get Customer by Phone Number
      security:
        - sessionToken: []
      parameters:
        - name: phone
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Customer retrieved successfully

  /customer:
    post:
      summary: Create Customer
      description: Create a new customer profile with required contact information
      security:
        - sessionToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - customerName
                - email
                - phone
                - birthDay
              properties:
                customerName:
                  type: string
                  example: "John Doe"
                  description: Customer's full name
                email:
                  type: string
                  format: email
                  example: "john.doe@example.com"
                  description: Customer's email address
                phone:
                  type: string
                  example: "+1-555-123-4567"
                  description: Customer's primary phone number
                whatsAppPhone:
                  type: string
                  example: "+1-555-123-4567"
                  description: Customer's WhatsApp phone number (optional, defaults to phone if not provided)
                birthDay:
                  type: string
                  format: date
                  example: "1990-01-15"
                  description: Customer's birth date (YYYY-MM-DD format)
                region:
                  type: string
                  example: "US"
                  description: Customer's region/country code (e.g., US, CA, GB)
                gender:
                  type: string
                  example: "Male"
                  description: Customer's gender (optional)
      responses:
        '200':
          description: Customer created successfully
          content:
            application/json:
              schema:
                type: string
                example: "Welcome: John Doe"
        '400':
          description: Invalid request data
        '401':
          description: Unauthorized - Invalid or missing session token
        '409':
          description: Customer already exists

  /user:
    post:
      summary: Create User
      description: Register a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userName
                - email
                - password
                - phone
                - birthDate
                - verifyPassword
                - agreedToTermsOfUseDate
                - agreedToCookiePolicyDate
                - agreedToPrivacyPolicyDate
                - agreedToTextMessageDate
              properties:
                userName:
                  type: string
                  format: email
                  example: sammy.johnson@gmail.com
                  description: Username (typically email address)
                email:
                  type: string
                  format: email
                  example: sammy.johnson@gmail.com
                  description: User's email address
                password:
                  type: string
                  example: P@ssw0rd12
                  description: User's password
                phone:
                  type: string
                  example: "8017551212"
                  description: User's phone number
                birthDate:
                  type: string
                  format: date
                  example: "2001-01-01"
                  description: User's birth date (YYYY-MM-DD)
                verifyPassword:
                  type: string
                  example: P@ssw0rd12
                  description: Password confirmation (must match password)
                agreedToTermsOfUseDate:
                  type: number
                  example: 1714444830351
                  description: Timestamp when user agreed to terms of use
                agreedToCookiePolicyDate:
                  type: number
                  example: 1714444830351
                  description: Timestamp when user agreed to cookie policy
                agreedToPrivacyPolicyDate:
                  type: number
                  example: 1714444830351
                  description: Timestamp when user agreed to privacy policy
                agreedToTextMessageDate:
                  type: number
                  example: 1714444830351
                  description: Timestamp when user agreed to text messages
      responses:
        '200':
          description: User created successfully
        '400':
          description: Invalid input data
        '409':
          description: User already exists

  /pushtokentestonly/{userName}:
    get:
      summary: Get Push Token
      security:
        - sessionToken: []
      parameters:
        - name: userName
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Push token retrieved successfully